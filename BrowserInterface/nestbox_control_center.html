<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">

    <title>Nestbox Control Center</title>
    <img src="owl.png"
    height="200px"
    widht="200px"
    > 

    <style>
      html, pre {
        font-family: sans-serif;
      }

      body {
        width: 500px;
        margin: 0 auto;
        background-color: white;
      }


      label {
        width: 200px;
        margin-right: 33px;
      }

      select {
        width: 350px;
        padding: 5px;
      }

      .slidecontainer {
      width: 96%;
      }

      .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 25px;
        background: #d3d3d3;
        outline: none;
        opacity: 0.7;
        -webkit-transition: .2s;
        transition: opacity .2s;
      }

      .slider:hover {
        opacity: 1;
      }

      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        background: #4CAF50;
        cursor: pointer;
      }

      .slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        background: #4CAF50;
        cursor: pointer;
      }
    </style>
    <!--[if lt IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    
    <h1>Nestbox Control Center</h1>

    <h2 id="online_status">Please connect to the Nestbox Wi-Fi.</h2>


    <h4>Current time on your Computer: <em id="time_local">?</em></h4>

    <h4>Current time on the Nestbox: <em id="time_remote">?</em></h4>


     <button type="button" id="btn_fetch_time" style="width:130px"
     >Get time from the Nestbox
     </button> 

     <button type="button" id="btn_set_time" style="width:170px" >Set time on the Nestbox to browser time</button> 

     <div class="slidecontainer">
      <p>Daily shut-down time: <b id="shdn">8:00</b> CET</p>
        <input type="range" min="6" max="138" value="48" class="slider" id="shdn_slider">
      <p>Daily wake-up time: <b id="wake">16:00</b> CET</p>
        <input type="range" min="6" max="138" value="96" class="slider" id="wake_slider">
      <p id="rtcwarning" style="color:red;"></p>

    </div>
    <div>
      <button type="button" id="btn_get_rtc" style="width:170px"
     >Fetch programmed shut-down and wake-up times.
     </button> 

      <button type="button" id="btn_set_rtc" style="width:170px" >Set shut-down and wake-up times</button> 
    </div>

    <p>Programmed shutdown: Nestbox is asleep form <b id="shdn_dev">?</b> to <b id="wake_dev">?</b> CET.</p>


    <hr>



     <h4>Current battery level: <em id="battery_level">?</em></h4>

     <table border="1" style="text-align: left;">
      <tr>
        <th>meas. ADC offset value: <em id="offset_val">?</em></th>
        <th>meas. ADC sensor value: <em id="adc_val">?</em></th>
      </tr>
      <tr>
      </tr>
      <tr>
        <th>ADC offset: <input type="number" id="ADC_offset" value="0.0"></th>
        <th>ADC scaling: <input type="number" id="ADC_scaling" value="1098.9"></th>
      </tr>
    </table>

    <div>
    </br>
      <button type="button" id="btn_weight_update" style="width:130px"
       >Get new weight measurement.
       </button> 
        <button type="button" id="btn_offset_update" style="width:130px"
       >Get last offset value.
       </button> 
      <h4>Estimated weight: <em id="weight_estimate">?</em></h4>
    </div>


<hr>  
  <button type="button" id="btn_start_calib" style="width:130px"
     >Start Calibration mode
     </button> 
  <button type="button" id="btn_stop_calib" style="width:130px"
     >Stop Calibration mode
     </button> 
  <p id="calib_status" style="color:black;"></p>

<pre> 
<table style="width:100%">
  <tr>
  	<th>ID</th>
    <th>ADC sensor value</th>
    <th>Weight (g)</th> 
  </tr>
  <tr>
  	<td>N°1</td> 
   	<td><input type="number" id="1;1" value="0.0"></td>
	<td><input type="number" id="1;2" value="0.0"></td>		
  </tr>
  <tr>
  	<td>N°2</td> 
    <td><input type="number" id="2;1" value="0.0"></td>
    <td><input type="number" id="2;2" value="0.0"></td>
  </tr>
  <tr>
  	<td>N°3</td> 
    <td><input type="number" id="3;1" value="0.0"></td>
    <td><input type="number" id="3;2" value="0.0"></td>
  </tr>
</table>
<style>table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}
}</style>

    </pre>

    <script>
      var onlineStatus = document.getElementById('online_status');  
      var timestampDisplay = document.getElementById('time_local');
      var timestampRemoteDisplay = document.getElementById('time_remote');
      var batterylevel = document.getElementById('battery_level');
      var weightEstimate = document.getElementById('weight_estimate');
      var offsetVal = document.getElementById('offset_val');
      var adcVal = document.getElementById('adc_val');
      var b_field = document.getElementById('ADC_offset');
      var a_field = document.getElementById('ADC_scaling');

      var btnFetch = document.getElementById('btn_fetch_time');
      var btnSet = document.getElementById('btn_set_time');
      var btnFetchRTC = document.getElementById('btn_get_rtc');
      var btnSetRTC = document.getElementById('btn_set_rtc');

      var btnWeight = document.getElementById('btn_weight_update');
      var btnOffset = document.getElementById('btn_offset_update');

      var btnStartCalib = document.getElementById('btn_start_calib');
      var btnStopCalib = document.getElementById('btn_stop_calib');
      var calibStatus = document.getElementById('calib_status');

      var shdn_slider = document.getElementById("shdn_slider");
      var wake_slider = document.getElementById("wake_slider");
      
      var shdn_time = document.getElementById("shdn");
      var wake_time = document.getElementById("wake");
      var rtcwarning = document.getElementById("rtcwarning");
      var shdn_dev = document.getElementById("shdn_dev");
      var wake_dev = document.getElementById("wake_dev");

      // Update the current slider value (each time you drag the slider handle)
      shdn_slider.oninput = function() {
        shdn_time.innerHTML = Math.floor(this.value/6) + ":" + (this.value*10-Math.floor(this.value/6)*60);
        if(shdn_slider.value>wake_slider.value-6)
        {
          rtcwarning.innerHTML = "Wake-up time must be at least one hour after shut-down time!"
        }
        else
        {
          rtcwarning.innerHTML = "";
        }
      } 

      // Update the current slider value (each time you drag the slider handle)
      wake_slider.oninput = function() {
        wake_time.innerHTML = Math.floor(this.value/6) + ":" + (this.value*10-Math.floor(this.value/6)*60);
        if(shdn_slider.value>wake_slider.value-6)
        {
          rtcwarning.innerHTML = "Wake-up time must be at least one hour after shut-down time!";
        }
        else
        {
          rtcwarning.innerHTML = "";
        }
      }

      btnFetchRTC.onclick = function() {
        var url = "http://www.nestbox.local/rtcAlarmUpdate";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            parseServerResponse(text);
          });
        });  
      };

      btnSetRTC.onclick = function() {
        var ph = "ph="+Math.floor(shdn_slider.value/6-1);
        var pm = "&pm="+(shdn_slider.value*10-Math.floor(shdn_slider.value/6)*60);
        var rh = "&rh="+Math.floor(wake_slider.value/6-1);
        var rm = "&rm="+(wake_slider.value*10-Math.floor(wake_slider.value/6)*60);

        var url = "http://www.nestbox.local/rtcAlarmUpdate?"+ph+pm+rh+rm;
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            parseServerResponse(text);
          });
        });  
      };




      function updateClock()
      {
        var date = new Date();
        var t = date.getTime();

        
        var dt = new Date(t);
        var hr = dt.getHours();
        var m = "0" + dt.getMinutes();
        var s = "0" + dt.getSeconds();
        var timestamp =  hr+ ':' + m.substr(-2) + ':' + s.substr(-2); 
        timestampDisplay.textContent = dt.toLocaleString() //timestamp;

        setTimeout(updateClock, 1000);
      }
      updateClock();

      function parseServerResponse(text)
      {
        if(text)
        {
           onlineStatus.textContent = "Device online!";
        }
        if(text[0] == 'B')
        {
          var voltage = parseInt(text.substr(1,10))/1000;
          console.log(voltage);

          batterylevel.textContent = voltage + " Volts";
        } 
        if(text[0] == 'W')
        {
          var weight = parseInt(text.substr(1,20));
          adcVal.textContent = weight;
                  calculateWeight();
        }
        if(text[0] == 'O')
        {
          var weight = parseInt(text.substr(1,20));
          offsetVal.textContent = weight;
                  calculateWeight();
        }
        if(text[0] == 'L')
        {
          calibStatus.innerHTML = "Calibration mode STARTED"
          calibStatus.style = "color:green;"

        }
        if(text[0] == 'l')
        {
          calibStatus.innerHTML = "Calibration mode OFF"
          calibStatus.style = "color:black;"
        }
        if(text[0] == 'Z')
        {
          var timeremote = parseInt(text.substr(1,11));
          console.log(timeremote);
          
          var dt = new Date(timeremote*1000);
          var hr = dt.getHours();
          var m = "0" + dt.getMinutes();
          var s = "0" + dt.getSeconds();
          var timestamp =  hr+ ':' + m.substr(-2) + ':' + s.substr(-2); 
          timestampRemoteDisplay.textContent = dt.toLocaleString(); //timestamp;

        }
        if(text[0] == 'S')
        {
          var rtcremote = parseInt(text.substr(1,11));
          
          var ph = ((rtcremote>>24) & 0xFF) +1;
          var pm = (rtcremote>>16) & 0xFF;
          var rh = ((rtcremote>>8) & 0xFF) + 1;
          var rm = (rtcremote) & 0xFF;

          shdn_dev.innerHTML =  ph+ ':' + pm; 
          wake_dev.innerHTML =  rh+ ':' + rm; 
        }


      }

      function updateBattery()
      {
        var url = "http://www.nestbox.local/battery";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            parseServerResponse(text)
          });
        });  
        setTimeout(updateBattery, 30000);
      }
      updateBattery();

      function fetchWeight()
      {
        var url = "http://www.nestbox.local/weight";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
                        console.log("weight resp: "+text)   
            parseServerResponse(text)
          });
        });  
      }
      
      function fetchOffset()
      {
        var url = "http://www.nestbox.local/offset";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            console.log("offset resp: "+text)
            parseServerResponse(text)
          });
        });  
      }

      function calculateWeight()
      {
        var a = a_field.value;
        var b = b_field.value;
        console.log("a="+a)
        console.log("b="+b)

        var weight_est = (parseInt(adcVal.textContent) - b)/a;
        weightEstimate.textContent = weight_est;

      }

      function ConnectionTest()
      {
        // var url = "http://www.nestbox.local/";
        // fetch(url).then(function(response) {
        //   response.text().then(function(text) {
        //     if(text=="Hello world")
        //     {
        //       alert("Connected to Nestbox Control Center");
        //     }
        //     else
        //     {
        //       alert("Connection failed")
        //     }
        //   }, function(resp) {alert("Connection failed")});
        // });  
        var url = "http://www.nestbox.local/heartbeat";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            
          });
        });  
       
        setTimeout(ConnectionTest, 10010);
      }
      //ConnectionTest();
      

      btnFetch.onclick = function() {
      console.log("fetch time")    
        var url = "http://www.nestbox.local/time";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            parseServerResponse(text);
          });
        });  
      };

      btnSet.onclick = function() {
        console.log("Set time");
        var ts = Math.round((new Date()).getTime() / 1000);
        console.log("epoch = "+ts);

        var url = "http://www.nestbox.local/time?set="+ts;
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            parseServerResponse(text);
          });
        });  
      };

      btnWeight.onclick = function() {
        console.log("Weight update");
        fetchWeight();  
        calculateWeight();
      };

      btnOffset.onclick = function() {
        console.log("Offset update");
        fetchOffset();  
      };

      btnStartCalib.onclick = function() {
      var url = "http://www.nestbox.local/LoadCellOn";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            parseServerResponse(text);
          });
        });  
      };

      btnStopCalib.onclick = function() {
      var url = "http://www.nestbox.local/LoadCellOff";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            parseServerResponse(text);
          });
        });  
      };
  
      // var imgTestInternet = "Hello World";
      // var urltest = "http://www.nestbox.local/";
      
      // fetch(urltest).then(alert("Connected to Nestbox Control Center"),alert("Connection failed"));
        
    </script>
  </body>
</html>
