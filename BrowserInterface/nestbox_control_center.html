<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">

    <title>Nestbox Control Center</title>
    <img src="owl.png"
    height="200px"
    widht="200px"
    > 

    <style>
      html, pre {
        font-family: sans-serif;
      }

      body {
        width: 500px;
        margin: 0 auto;
        background-color: white;
      }


      label {
        width: 200px;
        margin-right: 33px;
      }

      select {
        width: 350px;
        padding: 5px;
      }

    </style>
    <!--[if lt IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    
    <h1>Nestbox Control Center</h1>

    <h2 id="online_status">device offline</h2>


    <h4>Current time on your computer (UTC): <em id="time_local">?</em></h4>

    <h4>Current time on the nestbox (UTC): <em id="time_remote">?</em></h4>


     <button type="button" id="btn_fetch_time" style="width:130px"
     >Get time from the Nestbox
     </button> 

     <button type="button" id="btn_set_time" style="width:170px" >Set time on the Nestbox to browser time</button> 

     <h4>Current battery level: <em id="battery_level">?</em></h4>

     <table border="1" style="text-align: left;">
      <tr>
        <th>meas. ADC offset value: <em id="offset_val">?</em></th>
        <th>meas. ADC sensor value: <em id="adc_val">?</em></th>
      </tr>
      <tr>
      </tr>
      <tr>
        <th>ADC offset: <input type="number" id="ADC_offset" value="0.0"></th>
        <th>ADC offset: <input type="number" id="ADC_scaling" value="1098.9"></th>
      </tr>
    </table>

    <div>
    </br>
      <button type="button" id="btn_weight_update" style="width:130px"
       >Get new weight measurement
       </button> 

      <h4>Estimated weight: <em id="weight_estimate">?</em></h4>
    </div>

    <pre>

    </pre>

    <script>
      var onlineStatus = document.getElementById('online_status');  
      var timestampRemoteDisplay = document.getElementById('time_remote');
      var batterylevel = document.getElementById('battery_level');
      var weightEstimate = document.getElementById('weight_estimate');
      var offsetVal = document.getElementById('offset_val');
      var adcVal = document.getElementById('adc_val');
      var b_field = document.getElementById('ADC_offset');
      var a_field = document.getElementById('ADC_scaling');

      var btnFetch = document.getElementById('btn_fetch_time');
      var btnSet = document.getElementById('btn_set_time');
      var btnWeight = document.getElementById('btn_weight_update');



      function updateClock()
      {
        var date = new Date();
        var t = date.getTime();

        var timestampDisplay = document.getElementById('time_local');
        
        var dt = new Date(t);
        var hr = dt.getHours();
        var m = "0" + dt.getMinutes();
        var s = "0" + dt.getSeconds();
        var timestamp =  hr+ ':' + m.substr(-2) + ':' + s.substr(-2); 
        timestampDisplay.textContent = timestamp;

        setTimeout(updateClock, 1000);
      }
      updateClock();

      function parseServerResponse(text)
      {
        if(text == "H1")
        {
           onlineStatus.textContent = "Device online!";
        }
        if(text[0] == 'B')
        {
          var voltage = parseInt(text.substr(1,10))/1000;
          console.log(voltage);

          batterylevel.textContent = voltage + " Volts";
        } 
        if(text[0] == 'W')
        {
          var weight = parseInt(text.substr(1,20));
          adcVal.textContent = weight;
        }
        if(text[0] == 'O')
        {
          var weight = parseInt(text.substr(1,20));
          offsetVal.textContent = weight;
        }


      }

      function updateBattery()
      {
        var url = "http://www.nestbox.local/battery";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            parseServerResponse(text)
          });
        });  
        setTimeout(updateBattery, 30000);
      }
      updateBattery();

      function fetchWeight()
      {
        var url = "http://www.nestbox.local/weight";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            parseServerResponse(text)
          });
        });  
      }
      
      function fetchOffset()
      {
        var url = "http://www.nestbox.local/offset";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            parseServerResponse(text)
          });
        });  
      }

      function calculateWeight()
      {
        var a = a_field.value;
        var b = b_field.value;
        console.log("a="+a)
        console.log("b="+b)

        var weight_est = (parseInt(adcVal.textContent) - b)/a;
        weightEstimate.textContent = weight_est;

      }

      function ConnectionTest()
      {
        // var url = "http://www.nestbox.local/";
        // fetch(url).then(function(response) {
        //   response.text().then(function(text) {
        //     if(text=="Hello world")
        //     {
        //       alert("Connected to Nestbox Control Center");
        //     }
        //     else
        //     {
        //       alert("Connection failed")
        //     }
        //   }, function(resp) {alert("Connection failed")});
        // });  
        var url = "http://www.nestbox.local/heartbeat";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            
          });
        });  
       
        setTimeout(ConnectionTest, 5000);
      }
      ConnectionTest();
      

      btnFetch.onclick = function() {
      console.log("fetch time")    
        var url = "http://www.nestbox.local/time";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            timestampRemoteDisplay.textContent = text;
          });
        });  
      };

      btnSet.onclick = function() {
      console.log("Set time")    
        var url = "http://www.nestbox.local/time?set=123456";
        fetch(url).then(function(response) {
          response.text().then(function(text) {
            timestampRemoteDisplay.textContent = text;
          });
        });  
      };

      btnWeight.onclick = function() {
        console.log("Weight update");
        fetchWeight();  
        fetchOffset();
        calculateWeight();
      };
  
      // var imgTestInternet = "Hello World";
      // var urltest = "http://www.nestbox.local/";
      
      // fetch(urltest).then(alert("Connected to Nestbox Control Center"),alert("Connection failed"));
        
    </script>
  </body>
</html>
